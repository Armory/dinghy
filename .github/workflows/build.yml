on: [push, pull_request]

name: Build

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go: [ '1.13.10']
    name: Go ${{ matrix.go }} build
    steps:
      - name: Setup go
        uses: actions/setup-go@v1
        with:
          go-version: ${{ matrix.go }}

      # - name: Cache Build Dependencies  # Speeds up subsquent builds
      #   uses: actions/cache@v1
      #   with:
      #     path: ~/go/pkg/mod
      #     key: go-${{ hashFiles('**/go.sum') }}

      # - name: Check out code into the Go module directory
      #   uses: actions/checkout@v2

      # - name: Build
      #   run: go build -v .

      # - name: Test
      #   run: go test -v -mod=vendor ./...

      - name: Download dinghy-io
        uses: actions/checkout@v2
        with:
          repository: armory-io/dinghy
          token: ${{ secrets.ARMORYIO_GITHUB_TOKEN }}
          path: dinghy-io
          ref: refs/heads/master
      
      - name: Commit PR to update dinghy-io
        # if: github.ref == 'refs/heads/master'
        run:  |
          cd $GITHUB_WORKSPACE/dinghy-io
          git config user.name github-actions
          git config user.email github-actions@github.com
          git checkout -b update-dinghy
          git reset --hard origin/master
          go get github.com/armory/dinghy@master
          go mod vendor
          go mod tidy
          git add --all
          git commit -m "Update dinghy"
          git push --set-upstream origin $(git_current_branch)

          


