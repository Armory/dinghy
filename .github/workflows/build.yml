on: [push, pull_request]

name: Build

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go: [ '1.13.10']
    name: Go ${{ matrix.go }} build
    steps:
      - name: Setup go
        uses: actions/setup-go@v1
        with:
          go-version: ${{ matrix.go }}

      # - name: Cache Build Dependencies  # Speeds up subsquent builds
      #   uses: actions/cache@v1
      #   with:
      #     path: ~/go/pkg/mod
      #     key: go-${{ hashFiles('**/go.sum') }}

      # - name: Check out code into the Go module directory
      #   uses: actions/checkout@v2

      # - name: Build
      #   run: go build -v .

      # - name: Test
      #   run: go test -v -mod=vendor ./...

      - name: Download dinghy-io
        uses: actions/checkout@v2
        with:
          repository: armory-io/dinghy
          token: ${{ secrets.ARMORYIO_GITHUB_TOKEN }}
          path: dinghy-io
          ref: refs/heads/master
      
      - name: Update dinghy-io
        # if: github.ref == 'refs/heads/master'
        run:  |
          cd $GITHUB_WORKSPACE/dinghy-io
          git config user.name github-actions
          git config user.email github-actions@github.com
          git checkout -b update-dinghy
          git reset --hard origin/master
          go get github.com/armory/dinghy@master
          go mod vendor
          go mod tidy
          git add --all  
          git commit -m "${{github.event.commits[0].message}}"
          git branch --set-upstream-to=update-dinghy
          git push --force

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.ARMORYIO_GITHUB_TOKEN }}
          commit-message: ${{github.event.commits[0].message}}
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: false
          branch: update-dinghy
          title: ${{github.event.commits[0].message}}
          body: |
            Update dinghy
            - Updated with *latest* dinghy version
          labels: |
            automated pr
          team-reviewers: |
            ico
          draft: false


